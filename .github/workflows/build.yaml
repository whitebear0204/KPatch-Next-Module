name: Build

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
  workflow_dispatch:

env:
  MODULE_NAME: 'KPatch-Next-Module'

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set_vars.outputs.version }}
      check_tag: ${{ steps.check_tag.outputs.need_release }}
    steps:
    - name: Checkout
      uses: actions/checkout@v6
      with:
        fetch-depth: 1

    - name: download kpatch-next binaries (latest release)
      run: |
        mkdir -p module/bin
        LATEST_TAG=$(curl -s https://api.github.com/repos/KernelSU-Next/KPatch-Next/releases/latest \
                     | grep '"tag_name":' \
                     | sed -E 's/.*"([^"]+)".*/\1/')
        echo "Latest tag: $LATEST_TAG"
        ASSETS_URL="https://github.com/KernelSU-Next/KPatch-Next/releases/download/$LATEST_TAG"
        FILES=("kpatch-android" "kptools-android" "kpimg-linux")
        for f in "${FILES[@]}"; do
          echo "Downloading $f..."
          curl -sL "$ASSETS_URL/$f" -o "module/bin/$f"
          case $f in
            "kpatch-android") mv "module/bin/$f" "module/bin/kpatch" ;;
            "kptools-android") mv "module/bin/$f" "module/bin/kptools" ;;
            "kpimg-linux") mv "module/bin/$f" "module/bin/kpimg" ;;
          esac
        done

    - name: build webroot
      run: |
        cd webui
        npm ci
        npm run build

    - name: Upload artifact
      uses: actions/upload-artifact@v6
      with:
        name: ${{ env.MODULE_NAME }}-${{ github.run_number }}
        path: 'module'

    - name: Check if valid to release
      id: check_tag
      run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "need_release=false" >> $GITHUB_OUTPUT
          else
            git fetch --tags
            VERSION="$(jq -r .version update.json)"
            if [ -z "$VERSION" ]; then
              echo "need_release=false" >> $GITHUB_OUTPUT
            elif git tag | grep -qx "^${VERSION}"; then
              echo "need_release=false" >> $GITHUB_OUTPUT
            else
              echo "version=${VERSION}" >> $GITHUB_OUTPUT
              echo "need_release=true" >> $GITHUB_OUTPUT
            fi
          fi

  release:
    runs-on: ubuntu-latest
    needs: build
    if: needs.release.outputs.check_tag == 'true'
    steps:
    - name: Checkout
      uses: actions/checkout@v6
      with:
        fetch-depth: 2

    - name: Download artifact
      uses: actions/download-artifact@v7
      with:
        name: ${{ env.MODULE_NAME }}-${{ github.run_number }}
        path: ${{ env.MODULE_NAME }}

    - name: Zip for release
      run: cd ${{ env.MODULE_NAME }} && zip -r ../${{ env.MODULE_NAME }}.zip .

    - name: Generate changelog
      run: |
        CHANGELOG_RAW=$(git diff HEAD^ HEAD -- "CHANGELOG.md" | grep '^+[^+]' | sed 's/^+//')
        {
          echo "CHANGELOG<<EOF"
          echo -e "${CHANGELOG_RAW}"
          echo "EOF"
        } >> $GITHUB_ENV

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ needs.release.outputs.version }}
        name: ${{ needs.release.outputs.version }}
        body: ${{ env.CHANGELOG }}
        files: ${{ env.MODULE_NAME }}.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
